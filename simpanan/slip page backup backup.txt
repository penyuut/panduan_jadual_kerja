<?php
session_start();

$conn = new mysqli('localhost', 'root', '', 'jadual');
if ($conn->connect_error) {
    die("Connection failed: " . $conn->connect_error);
}

// Check if the 'negeri' POST variable is set
$negeri = isset($_POST['negeri']) ? $_POST['negeri'] : '';  // Default to empty string if not set


if (isset($_POST['add_approved_item'])) {
    $item_name = $_POST['item_name'];
    $price = $_POST['price'];
    $quantity = $_POST['quantity'];

    // Prepare and bind
    $stmt = $conn->prepare("INSERT INTO approved_items (item_name, price, quantity) VALUES (?, ?, ?)");
    $stmt->bind_param("sdi", $item_name, $price, $quantity);  // s = string, d = double, i = integer

    if ($stmt->execute()) {
        echo "<script>alert('Item added successfully.');</script>";
    } else {
        echo "Error: " . $stmt->error;
    }

    $stmt->close();
}


// Handle item removal
if (isset($_POST['remove_approved_item'])) {
    $item_id = $_POST['item_id'];
    $remove_sql = "DELETE FROM approved_items WHERE id = '$item_id'";
    if ($conn->query($remove_sql) === TRUE) {
        echo "<script>alert('Approved item removed successfully!');</script>";
    } else {
        echo "Error removing approved item: " . $conn->error;
    }
}

// Fetch approved items from the database
$approved_items_result = $conn->query("SELECT * FROM approved_items");
$approved_items = $approved_items_result->fetch_all(MYSQLI_ASSOC);

// Initialize totals
$totalAmount = 0;
$totalApprovedAmount = 0;

// Calculate total amount from the cart
if (!empty($_SESSION['cart'])) {
    foreach ($_SESSION['cart'] as $item) {
        $totalAmount += $item['harga'] * $item['kuantiti'];
    }
}

// Calculate total approved amount
foreach ($approved_items as $item) {
    $totalApprovedAmount += $item['price'] * $item['quantity'];
}

// Unified Tax Calculation
$taxRate = 0;
$vehicleTaxRate = 0;
$taxRates = [
    'kangar' => [
        'lessThan16' => 0.04,
        'between16And32' => 0.09,
        'between32And48' => 0.12,
        'moreThan48' => 0.14
    ],
    'kota setar' => [
        'lessThan16' => 0.03,
        'between16And32' => 0.08,
        'between32And48' => 0.11,
        'moreThan48' => 0.13
    ],
];


// Handle tax and vehicle type submission
if (isset($_POST['submit_lokasi'])) {
    $distance = $_POST['jarak'];
    $district = strtolower($_POST['daerah']);
    $vehicleType = $_POST['vehicle_type'];

    // Determine tax rate based on distance
    if (isset($taxRates[$district])) {
        if ($distance < 16) {
            $taxRate = $taxRates[$district]['lessThan16'];
        } elseif ($distance <= 32) {
            $taxRate = $taxRates[$district]['between16And32'];
        } elseif ($distance <= 48) {
            $taxRate = $taxRates[$district]['between32And48'];
        } else {
            $taxRate = $taxRates[$district]['moreThan48'];
        }
    }

    // Determine vehicle tax rate
    if ($vehicleType === 'kenderaan_air') {
        $vehicleTaxRate = 0.05; // 5%
    } elseif ($vehicleType === 'kenderaan_darat') {
        $vehicleTaxRate = 0.02; // 2%
    }
}

// Calculate the taxes
$totalAmountIncludingApprovedItems = $totalAmount + $totalApprovedAmount;
$taxAmount = $totalAmountIncludingApprovedItems * $taxRate;
$vehicleTaxAmount = $totalAmountIncludingApprovedItems * $vehicleTaxRate;
$totalTax = $taxAmount + $vehicleTaxAmount;

// Calculate Jumlah Nilai Kerja
$jumlahNilaiKerja = $totalAmountIncludingApprovedItems;

// Calculate Jumlah Besar (Jumlah Nilai Kerja + Total Cukai)
$jumlahBesar = $jumlahNilaiKerja + $totalTax;

// Apply condition to include/exclude tax based on Jumlah Nilai Kerja
$CukaiMoreRM1000 = 0; // Initialize as 0
$taxAmountLessThan1000 = 0;

if ($jumlahNilaiKerja < 1000) {
    // If Jumlah Nilai Kerja < RM 1000, tax is 20%
    $taxAmountLessThan1000 = $jumlahBesar * 0.20; // 20% tax applied
    $CukaiMoreRM1000 = $jumlahBesar + $taxAmountLessThan1000; // Jumlah Nilai Kerja + 20% tax
} else {
    // If Jumlah Nilai Kerja >= RM 1000, tax is not included
    $CukaiMoreRM1000 = $jumlahBesar; // No tax added
}




?>

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Slip Page</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f0f4f8;
            margin: 0;
            padding: 20px;
            color: #333;
        }

        h1,
        h2,
        h3 {
            color: #1E3A8A;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }

        table th,
        table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        table th {
            background-color: #3B82F6;
            color: white;
        }

        .form-section {
            border: 1px solid #ddd;
            padding: 20px;
            margin-top: 20px;
            background-color: #fff;
            border-radius: 8px;
        }
    </style>
    <script>
        const daerahOptions = {
            pahang: ['Bentong', 'Temerloh', 'Raub', 'Bera', 'Maran', 'Kuantan', 'Cameron Highlands', 'Kuala Lipis', 'Pekan', 'Jerantut', 'Rompin', 'Ulu Tembeling (Taman Negara)', 'Pulau Tioman'],
            johor: ['Johor Bahru', 'Pontian', 'Segamat', 'Kluang', 'Batu Pahat', 'Muar', 'Kota Tinggi', 'Mersing', 'Tangkak', 'Kulaijaya', 'Pulau Sibu dan Pulau Tinggi', 'Pulau Aur dan Pulau Pemanggil'],
            selangor: ['Semua daerah kecuali Sabak Bernam dan Kuala Selangor', 'Sabak Bernam dan Kuala Selangor', 'Pulau Ketam'],
            negeri_sembilan: ['Seremban', 'Kuala Pilah', 'Port Dickson', 'Tampin', 'Rembau', 'Kuala Klawang', 'Bandar Baru Serting'],
            melaka: ['Bandar Melaka'],
            kelantan: ['Kota Bahru', 'Bachok', 'Pasir Puteh', 'Pasir Mas', 'Tumpat', 'Tanah Merah', 'Machang', 'Jeli', 'Kuala Krai', 'Gua Musang'],
            kedah: ['Kota Setar', 'Sungai Petani', 'Kulim', 'Baling', 'Padang Terap', 'Yan', 'Sik', 'Bandar Baharu', 'Pendang', 'Langkawi'],
            pulau_pinang: ['Pulau Pinang', 'Butterworth', 'Bukit Bendera', 'Pulau-pulau'],
            perak: ['Kinta', 'Kuala Kangsar', 'Larut & Matang', 'Kerian', 'Batang Padang', 'Hilir Perak', 'Manjung', 'Perak Tengah', 'Hulu Perak', 'Pos Orang Asli', 'Pulau-pulau (Pulau Pangkor)'],
            terengganu: ['Kuala Terengganu', 'Dungun', 'Kemaman', 'Besut', 'Hulu Terengganu', 'Setiu', 'Marang', 'Pulau-Pulau'],
            labuan: ['Labuan', 'Pulau-pulau'],
            putrajaya: ['Putrajaya'],
            kuala_lumpur: ['Kuala Lumpur'],
            perlis: ['Kangar'],
            kesedar: ['Kesedar'],
            ketengah: ['Ketengah']
        };

	const negeriText = {
        pahang: 'JKR Elektrik Pahang (Pejabat pengeluar inden)',
        johor: 'JKR Elektrik Johor (Pejabat pengeluar inden)',
        selangor: 'JKR Elektrik Selangor (Pejabat pengeluar inden)',
        negeri_sembilan: 'JKR Elektrik Negeri Sembilan (Pejabat pengeluar inden)',
        melaka: 'JKR Elektrik Melaka (Pejabat pengeluar inden)',
        kelantan: 'JKR Elektrik Kelantan (Pejabat pengeluar inden)',
        kedah: 'JKR Elektrik Kedah (Pejabat pengeluar inden)',
        pulau_pinang: 'JKR Elektrik Pulau Pinang (Pejabat pengeluar inden)',
        perak: 'JKR Elektrik Perak (Pejabat pengeluar inden)',
        terengganu: 'JKR Elektrik Terengganu (Pejabat pengeluar inden)',
        labuan: 'JKR Elektrik Labuan (Pejabat pengeluar inden)',
        putrajaya: 'JKR Elektrik Putrajaya (Pejabat pengeluar inden)',
        kuala_lumpur: 'JKR Elektrik Kuala Lumpur (Pejabat pengeluar inden)',
        perlis: 'JKR Elektrik Perlis (Pejabat pengeluar inden)',
        kesedar: 'JKR Elektrik Kesedar (Pejabat pengeluar inden)',
        ketengah: 'JKR Elektrik Ketengah (Pejabat pengeluar inden)'
    };

	function toggleApprovalForm(show) {
    var approvalForm = document.getElementById('approvalForm');
    if (show) {
        approvalForm.style.display = 'block';
    } else {
        approvalForm.style.display = 'none';
    }
}


         // Function to update daerah dropdown based on selected negeri
        function updateDistricts() {
            const negeriSelect = document.getElementById('negeri');
            const daerahSelect = document.getElementById('daerah');
            const selectedNegeri = negeriSelect.value;

            // Clear previous options
            daerahSelect.innerHTML = '<option value="">Select Daerah</option>';

            // Check if selected negeri exists in daerahOptions
            if (daerahOptions[selectedNegeri]) {
                daerahOptions[selectedNegeri].forEach(daerah => {
                    const option = document.createElement('option');
                    option.value = daerah.toLowerCase(); // Ensure lowercase value
                    option.textContent = daerah;
                    daerahSelect.appendChild(option);
                });
            }
        }
    </script>
</head>

<body>
    <div>
        <h1>Slip Page</h1>

        <!-- Item JKKE-->
<div class="form-section">
    <h3>ITEM JKKE</h3>
    <table>
        <tr>
            <th>No</th>
            <th>Bil</th>
            <th>Bhg</th>
            <th>Keterangan</th>
            <th>Harga</th>
            <th>Kuantiti</th>
            <th>JUMLAH</th>
        </tr>
        <?php if (!empty($_SESSION['cart'])): ?>
            <?php foreach ($_SESSION['cart'] as $index => $item): ?>
                <tr>
                    <td><?= $index + 1 ?></td>
                    <td><?= htmlspecialchars($item['bil']) ?></td>
                    <td><?= htmlspecialchars($item['bhg']) ?></td>
                    <td><?= htmlspecialchars($item['keterangan']) ?></td>
                    <td>RM <?= number_format($item['harga'], 2) ?></td>
                    <td><?= htmlspecialchars($item['kuantiti']) ?></td>
                    <td>RM <?= number_format($item['harga'] * $item['kuantiti'], 2) ?></td>
                </tr>
            <?php endforeach; ?>
        <?php else: ?>
            <tr>
                <td colspan="7">No items in the cart</td>
            </tr>
        <?php endif; ?>
    </table>
    <p><strong>Jumlah Keseluruhan : RM <?= number_format($totalAmount, 2) ?></strong></p>

<h3>Tambah Item</h3>
        <li><a href="Bahagian I_User.php">BAHAGIAN I</a></li>
        <li><a href="Bahagian II_User.php">BAHAGIAN II</a></li>
        <li><a href="Bahagian III_User.php">BAHAGIAN III</a></li>
        <li><a href="Bahagian IV_User.php">BAHAGIAN IV</a></li>
        <li><a href="Bahagian V_User.php">BAHAGIAN V</a></li>
        <li><a href="Bahagian VI_User.php">BAHAGIAN VI</a></li>
        <li><a href="Bahagian VII_User.php">BAHAGIAN VII</a></li>
        </div>



	<div class="form-section">
    <h2>ITEM HARGA PERSETUJUAN</h2>
    <form method="post">
        <p><b>Ada Item Persetujuan?</b></p>
        <input type="radio" id="ada" name="item_approval" value="ada" onclick="toggleApprovalForm(true)">
        <label for="ada">Ada</label>
        <input type="radio" id="tiada" name="item_approval" value="tiada" onclick="toggleApprovalForm(false)">
        <label for="tiada">Tiada</label>

        <!-- Form for adding approved items (hidden by default) -->
        <div id="approvalForm" style="display: none;">
            <h3>Add Approved Item</h3>
            <label for="item_name">Item:</label>
            <input type="text" id="item_name" name="item_name" required>
            <br>
            <label for="price">Harga:</label>
            <input type="number" id="price" name="price" required step="0.01">
            <br>
            <label for="quantity">Kuantiti:</label>
            <input type="number" id="quantity" name="quantity" required>
            <br><br>
            <button type="submit" name="add_approved_item">Add New Item</button>
        </div>
    </form>

        <!-- Approved Items -->
    <div class="form-section">
        <h3>List Item Harga Persetujuan</h3>
        <table>
            <tr>
                <th>No</th>
                <th>Keterangan</th>
                <th>Bhg</th>
                <th>Bil</th>
                <th>Harga</th>
                <th>Kuantiti</th>
                <th>JUMLAH</th>
            </tr>
            <?php if (count($approved_items) > 0): ?>
                <?php foreach ($approved_items as $index => $item): ?>
                    <tr>
                        <td><?= $index + 1 ?></td>
                        <td><?= htmlspecialchars($item['item_name']) ?></td>
                        <td>-</td> <!-- Set Bhg as '-' -->
                        <td>-</td> <!-- Set Bil as '-' -->
                        <td>RM <?= number_format($item['price'], 2) ?></td>
                        <td><?= htmlspecialchars($item['quantity']) ?></td>
                        <td>RM <?= number_format($item['price'] * $item['quantity'], 2) ?></td>
                    </tr>
                <?php endforeach; ?>
            <?php else: ?>
                <tr>
                    <td colspan="7">No approved items</td>
                </tr>
            <?php endif; ?>
        </table>
        <p><strong>Jumlah Keseluruhan : RM <?= number_format($totalApprovedAmount, 2) ?></strong></p>
    </div>

        <h1>SLIP</h1>

        <!-- Lokasi Form -->
        <div class="form-section">
            <form method="post">
                <label><b>Projek:</b></label>
<input type="text" name="projek" required style="width: 300px; height: 40px;"><br>


                <br> <label><b>Jarak (km):</b></label>
                <input type="number" name="jarak" required><br>

                <br><label for="negeri"><b>Negeri:</b></label>
                <select id="negeri" name="negeri" onchange="updateDistricts()" required>
                    <option value="pahang">JKR Elektrik Pahang</option>
                    <option value="johor">JKR Elektrik Johor</option>
                    <option value="selangor">JKR Elektrik Selangor</option>
                    <option value="pahang">JKR Elektrik Pahang (Pejabat pengeluar inden)</option>
                    <option value="johor">JKR Elektrik Johor (Pejabat pengeluar inden)</option>
                    <option value="selangor">JKR Elektrik Selangor (Pejabat pengeluar inden)</option>
                    <option value="terengganu">JKR Elektrik Terengganu (Pejabat pengeluar inden)</option>
                    <option value="negeri_sembilan">JKR Elektrik Negeri Sembilan (Pejabat pengeluar inden)</option>
                    <option value="kelantan">JKR Elektrik Kelantan (Pejabat pengeluar inden)</option>
                    <option value="kedah">JKR Elektrik Kedah (Pejabat pengeluar inden)</option>
                    <option value="pulau pinang">JKR Elektrik Pulau Pinang (Pejabat pengeluar inden)</option>
                    <option value="melaka">JKR Elektrik Melaka (Pejabat pengeluar inden)</option>
                    <option value="perlis">JKR Elektrik Perlis (Pejabat pengeluar inden)</option>
                    <option value="putrajaya">JKR Elektrik Wilayah Persekutuan Putrajaya (Pejabat pengeluar inden)
                    </option>
                    <option value="kuala_lumpur">JKR Elektrik Wilayah Persekutuan Kuala Lumpur (Pejabat pengeluar inden)
                    </option>
                    <option value="labuan">JKR Elektrik Wilayah Persekutuan Labuan (Pejabat pengeluar inden)</option>
                    <option value="kesedar">JKR Elektrik KESEDAR (Pejabat pengeluar inden)</option>
                    <option value="ketengah">JKR Elektrik KETENGAH (Pejabat pengeluar inden)</option>
                    <!-- Add other negeri here -->
                </select><br>

                <label for="daerah">Daerah:</label>
                <select name="daerah" id="daerah" required>
                    <option value="">-- Pilih Daerah --</option>
                </select><br>

                <br><label><b>Kenderaan:<b></label><br>
                <input type="radio" name="vehicle_type" value="kenderaan_darat" required>Tambahan peratusan sebanyak 2%
                lagi dari JKKE hendaklah dibuat
                sekiranya jalan ke sesuatu tempat kerja hanya boleh dilalui oleh
                kenderaan darat berjentera beroda dua (two-wheel vehicle) atau
                kenderaan berjentera yang mempunyai pacuan empat roda (four-wheel
                drive vehicle).<br>

                <br> <input type="radio" name="vehicle_type" value="kenderaan_air">Tambahan peratusan sebanyak 5% lagi
                dari JKKE hendaklah dibuat
                sekiranya jalan ke sesuatu tempat kerja hanya boleh dilalui menggunakan
                kenderaan air dengan mengharungi sungai, tasik atau laut, tanpa
                jambatan.<br>


                <button type="submit" name="submit_lokasi">Calculate Tax</button>
            </form>
        </div>

          <!-- Tax Calculation Results -->
        <?php if (isset($_POST['submit_lokasi'])): ?>
            <div class="form-section">
                <h3>Slip</h3>
		<p><strong>Projek :  <strong><?= htmlspecialchars($_POST['projek']) ?></p>
		<p><strong>Jarak:</strong> <?= htmlspecialchars($_POST['jarak']) ?> km daripada
                    <?php
                    $negeriText = [
                        'pahang' => 'JKR Elektrik Pahang (Pejabat pengeluar inden)',
                        'johor' => 'JKR Elektrik Johor (Pejabat pengeluar inden)',
                        'selangor' => 'JKR Elektrik Selangor (Pejabat pengeluar inden)',
                        'negeri_sembilan' => 'JKR Elektrik Negeri Sembilan (Pejabat pengeluar inden)',
                        'melaka' => 'JKR Elektrik Melaka (Pejabat pengeluar inden)',
                        'kelantan' => 'JKR Elektrik Kelantan (Pejabat pengeluar inden)',
                        'kedah' => 'JKR Elektrik Kedah (Pejabat pengeluar inden)',
                        'pulau_pinang' => 'JKR Elektrik Pulau Pinang (Pejabat pengeluar inden)',
                        'perak' => 'JKR Elektrik Perak (Pejabat pengeluar inden)',
                        'terengganu' => 'JKR Elektrik Terengganu (Pejabat pengeluar inden)',
                        'labuan' => 'JKR Elektrik Labuan (Pejabat pengeluar inden)',
                        'putrajaya' => 'JKR Elektrik Putrajaya (Pejabat pengeluar inden)',
                        'kuala_lumpur' => 'JKR Elektrik Kuala Lumpur (Pejabat pengeluar inden)',
                        'perlis' => 'JKR Elektrik Perlis (Pejabat pengeluar inden)',
                        'kesedar' => 'JKR Elektrik Kesedar (Pejabat pengeluar inden)',
                        'ketengah' => 'JKR Elektrik Ketengah (Pejabat pengeluar inden)'
                    ];
                    echo htmlspecialchars($negeriText[$negeri] ?? ''); 
                    ?>
                </p>


             	<!-- DISPLAY TABLE ITEM JKKE AND ITEM HARGA PERSETUJUAN -->
		<h3>ITEM JKKE</h3>
<table>
    <tr>
        <th>No</th>
	<th>Keterangan</th>
	 <th>Bhg</th>
         <th>Bil</th>
            <th>Harga</th>
            <th>Kuantiti</th>
            <th>JUMLAH</th>
    </tr>
    <?php if (!empty($_SESSION['cart'])): ?>
        <?php foreach ($_SESSION['cart'] as $index => $item): ?>
            <tr>
                    <td><?= $index + 1 ?></td>
		    <td><?= htmlspecialchars($item['keterangan']) ?></td>
		    <td><?= htmlspecialchars($item['bhg']) ?></td>
                    <td><?= htmlspecialchars($item['bil']) ?></td>
                    <td>RM <?= number_format($item['harga'], 2) ?></td>
                    <td><?= htmlspecialchars($item['kuantiti']) ?></td>
                    <td>RM <?= number_format($item['harga'] * $item['kuantiti'], 2) ?></td>
                </tr>
        <?php endforeach; ?>
    <?php else: ?>
        <tr>
            <td colspan="5">No items in the cart</td>
        </tr>
    <?php endif; ?>
</table>

<h3>List Item Harga Persetujuan</h3>
    <table>
        <tr>
            <th>No</th>
                <th>Keterangan</th>
                <th>Bhg.</th>
                <th>Bil</th>
                <th>Harga</th>
                <th>Kuantiti</th>
                <th>JUMLAH</th>
        </tr>
        <?php if (!empty($approved_items)): ?>
            <?php foreach ($approved_items as $index => $item): ?>
                 <tr>
                        <td><?= $index + 1 ?></td>
                        <td><?= htmlspecialchars($item['item_name']) ?></td>
                        <td>-</td> <!-- Static '-' for Bhg -->
                        <td>-</td> <!-- Static '-' for Bil -->
                        <td>RM <?= number_format($item['price'], 2) ?></td>
                        <td><?= htmlspecialchars($item['quantity']) ?></td>
                        <td>RM <?= number_format($item['price'] * $item['quantity'], 2) ?></td>
                    </tr>
            <?php endforeach; ?>
        <?php else: ?>
            <tr>
                <td colspan="6">No approved items</td>
            </tr>
        <?php endif; ?>
    </table>
</div>


                <h4>PENGIRAAN TAMBAHAN PERATUSAN</h4>
		
                <p><strong>Jumlah Nilai Kerja:</strong> RM <?= number_format($jumlahNilaiKerja, 2) ?></p>

		<p><strong>i. Tambahan peratusan kawasan (Rujuk Jadual 1) :
		<br>&emsp;
		<?= number_format($taxRate * 100, 2) ?>% 
		daripada nilai kerja (NK) .... RM <?= number_format($taxAmount, 2) ?>
		</strong></p> 

		<p><strong>ii. Tambahan peratusan kesukaran logistik (Rujuk item 1.2.2/1.2.3) :
		<br>&emsp;
		<?= number_format($vehicleTaxRate * 100, 2) ?>%
		daripada nilai kerja (NK) .... RM <?= number_format($vehicleTaxAmount, 2) ?>
		</strong></p>
		

                <p><strong>Jumlah Besar (JB) 1 : ... RM <?= number_format($jumlahBesar, 2) ?></p>
		<p>Tambahan 20% daripada JB1 oleh sebab jumlah kurang dari RM1,000.00,
		<br> Rujuk item 1.2.4. 
		... RM <?= number_format($taxAmountLessThan1000, 2) ?>
		</strong></p>

		<p><strong><Jumlah Besar (JB) 2 ... RM <?= number_format($CukaiMoreRM1000, 2) ?></strong></p>


  

		<?php if ($jumlahNilaiKerja < 1000): ?>
                    <p><strong>Had maksimum bayaran kepada Kontraktor ... RM 1,000.00</strong></p>
                    <p><strong>Bayaran Muktamad ... RM 1,000.00</strong></p>
                <?php else: ?>
                    <h3>Bayaran Muktamad: RM <?= number_format($CukaiMoreRM1000, 2) ?></h3>
                <?php endif; ?>
            </div>
        <?php endif; ?>

    </div>
</body>

</html>